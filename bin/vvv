#!/bin/sh
#/ Usage: vvv [<options>] <env> [<command> [<args>]]
#/
#/ Options:
#/   -c ENV [virtualenv_opts] Create and activate a virtualenv
#/   -m ENV [virtualenv_opts] Create a virtualenv but don't activate
#/   -d ENV                   Delete a virtualenv
#/   -h                       Print this message and exit
PROGNAME=$(basename "$0")
VVV_ROOT="${VVV_ROOT:-$HOME/.virtualenvs}"

abort() {
  echo "$PROGNAME: $1" >&2
  exit 1
}

usage() {
  grep "^#/" $0 | cut -c4- >&2
  exit 2
}

activate() {
  VIRTUAL_ENV="$VVV_ROOT/$1"
  if [ ! -d "$VIRTUAL_ENV" ]; then
    if [ -n "$VVV_AUTO_CREATE" ]; then
      create "$1" "${@:2}"
    else
      abort "Unknown virtualenv '$1'"
    fi
  fi
  shift

  export VIRTUAL_ENV
  export PATH="$VIRTUAL_ENV/bin:$PATH"
  unset PYTHON_HOME
  exec "${@:-$SHELL}"
}

create() {
  [ -d "$VVV_ROOT/$1" ] && abort "virtualenv '$1' already exists"
  virtualenv ${@:2} "$VVV_ROOT/$1"
}

delete() {
  if [ -n "$VIRTUAL_ENV" ]; then
    if [ "$(basename $VIRTUAL_ENV)" = "$1" ]; then
      abort "Cannot delete the active virtualenv"
    fi
  fi
  rm -rf "$VVV_ROOT/$1"
}

list() {
  find "$VVV_ROOT" -maxdepth 1 -type d | sed '1d' | xargs -n1 basename 2> /dev/null
  exit
}

while getopts :hd:c:m: o; do
  case "$o" in
    d)
      delete "$OPTARG"
      exit
      ;;
    c)
      create "$OPTARG" "${@:3}"
      activate "$OPTARG"
      exit
      ;;
    m)
      create "$OPTARG" "${@:3}"
      exit
      ;;
    h|\?|:)
      usage
      ;;
  esac
done

shift $((OPTIND-1))

# make sure $VVV_ROOT exists
[ -d "$VVV_ROOT" ] ||  abort "$VVV_ROOT does not exist"

# no arguments so print all virtualenvs
[ $# -eq 0 ] && list

# go!
activate "$1" "${@:2}"
